function doPost(e) {
  try {
    // Parse the incoming data
    const data = JSON.parse(e.postData.contents);
    
    // Get or create the spreadsheet
    const spreadsheetId = '1T6ECiFMHjFgv0CF2sz9V-iYjBKoTRbYfvBM3D0wTKIA';
    const ss = SpreadsheetApp.openById(spreadsheetId);
    
    // Always write champion data
    writeChampionData(ss, data);
    
    // Handle different submission types
    if (data.submissionType === 'pupil-only' || data.submissionType === 'both') {
      writePupilData(ss, data);
    }
    
    if (data.submissionType === 'staff-only' || data.submissionType === 'both') {
      writeStaffData(ss, data);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({result: 'success'}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    console.error('Error:', error);
    return ContentService
      .createTextOutput(JSON.stringify({result: 'error', error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function writeChampionData(ss, data) {
  // Get or create Champion Data sheet
  let championSheet = ss.getSheetByName('Champion Data');
  if (!championSheet) {
    championSheet = ss.insertSheet('Champion Data');
    // Add headers
    championSheet.getRange(1, 1, 1, 7).setValues([[
      'Timestamp', 'School Name', 'Champion First Name', 'Champion Surname', 
      'Champion Email', 'Champion Phone', 'Submission Type'
    ]]);
    championSheet.getRange(1, 1, 1, 7).setFontWeight('bold');
  }
  
  // Add data row
  const championData = data.championData;
  championSheet.appendRow([
    data.timestamp,
    championData.schoolName || '',
    championData.championFirstName || '',
    championData.championSurname || '',
    championData.championEmail || '',
    championData.championPhone || '',
    data.submissionType || ''
  ]);
}

function writePupilData(ss, data) {
  // Get or create Pupil Data sheet
  let pupilSheet = ss.getSheetByName('Pupil Data');
  if (!pupilSheet) {
    pupilSheet = ss.insertSheet('Pupil Data');
    // Add headers
    pupilSheet.getRange(1, 1, 1, 9).setValues([[
      'Timestamp', 'Nursery Classes', 'Nursery Pupils', 'Reception Classes', 
      'Reception Pupils', 'Years 1-4 Pupils', 'Years 5-6 Pupils', 
      'Year 6 Pupils', 'Total Classes'
    ]]);
    pupilSheet.getRange(1, 1, 1, 9).setFontWeight('bold');
  }
  
  // Add data row
  const pupilData = data.pupilData;
  pupilSheet.appendRow([
    data.timestamp,
    pupilData.nurseryClasses || '',
    pupilData.nurseryPupils || '',
    pupilData.receptionClasses || '',
    pupilData.receptionPupils || '',
    pupilData.years1to4 || '',
    pupilData.years5to6 || '',
    pupilData.year6 || '',
    pupilData.totalClasses || ''
  ]);
}

function writeStaffData(ss, data) {
  // Get or create Staff Data sheet
  let staffSheet = ss.getSheetByName('Staff Data');
  if (!staffSheet) {
    staffSheet = ss.insertSheet('Staff Data');
    // Add headers
    staffSheet.getRange(1, 1, 1, 7).setValues([[
      'Timestamp', 'First Name', 'Surname', 'Email', 'Job Title', 'Staff Type', 'Other Description'
    ]]);
    staffSheet.getRange(1, 1, 1, 7).setFontWeight('bold');
  }
  
  // Add each staff member
  data.staffData.forEach(staff => {
    staffSheet.appendRow([
      data.timestamp,
      staff.firstName || '',
      staff.surname || '',
      staff.email || '',
      staff.jobTitle || '',
      staff.staffType || '',
      staff.otherDescription || ''
    ]);
  });
}

// Test function (optional)
function testFunction() {
  const testData = {
    submissionType: 'both',
    timestamp: new Date().toISOString(),
    championData: {
      schoolName: 'Test Primary School',
      championFirstName: 'Jane',
      championSurname: 'Doe',
      championEmail: 'jane.doe@testschool.ac.uk',
      championPhone: '01234 567890'
    },
    pupilData: {
      nurseryClasses: '2',
      nurseryPupils: '30',
      receptionClasses: '3',
      receptionPupils: '45',
      years1to4: '120',
      years5to6: '60',
      year6: '30',
      totalClasses: '8'
    },
    staffData: [{
      firstName: 'John',
      surname: 'Smith',
      email: 'john.smith@school.ac.uk',
      jobTitle: 'Head Teacher',
      staffType: 'teaching',
      otherDescription: ''
    }]
  };
  
  const ss = SpreadsheetApp.openById('1T6ECiFMHjFgv0CF2sz9V-iYjBKoTRbYfvBM3D0wTKIA');
  writeChampionData(ss, testData);
  writePupilData(ss, testData);
  writeStaffData(ss, testData);
}
